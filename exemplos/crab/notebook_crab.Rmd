---
title: "Exemplos de Regressão Logística em R - Parte 2"
subtitle: "Análise de Dados Categorizados"
author: "Allan Vieira 14/0128492"
date: "May 10, 2018"
output:
  html_document:
    self_contained: false
    df_print: paged
  pdf_document: default
---

<!-- self_contained: false --- para nao dar pau do plotly com firefox -->
<!-- df_print para as formas de imprimir data frames e tibbles -->
<!-- ver https://rmarkdown.rstudio.com/html_document_format.html -->

<!-- incluir no cabecalho: -->
<!-- always_allow_html: yes  -->
<!--para quando formos passar para pdf -->

<style>
body {
text-align: justify}
</style>

<!-- para justificar texto no markdown -->
<!-- https://stackoverflow.com/questions/43222169/how-to-justify-the-text-to-both-sides-when-knitting-html-in-rmarkdown -->

<!-- <style> -->
<!--   .col2 { -->
<!--     columns: 2 200px;         /* number of columns and width in pixels*/ -->
<!--     -webkit-columns: 2 200px; /* chrome, safari */ -->
<!--     -moz-columns: 2 200px;    /* firefox */ -->
<!--   } -->
<!--   .col3 { -->
<!--     columns: 3 100px; -->
<!--     -webkit-columns: 3 100px; -->
<!--     -moz-columns: 3 100px; -->
<!--   } -->
<!-- </style> -->
<!-- esse de cima funciona no output do RStudio, mas nao nos browsers -->
<!-- tb em: https://stackoverflow.com/questions/31753897/2-column-section-in-r-markdown -->


---

---

### 2. Exemplo dos Carangueijos (Horseshoe Crabs)

---


#### **Preparação dos dados:**

```{r, message=FALSE, warning=FALSE}
library(readr)
library(dplyr)

crabs <- read_table2("/home/allan/Documents/1S2018/A_DADOS_CATEGORIZADOS/PARTE_GEORGE/parte2/exemplos/crab/crabs.txt", col_names = FALSE)

crabs <- crabs %>%
  magrittr::set_colnames(c("color", "spine", "width", "satell", "weight")) %>%
  na.omit() %>%
  dplyr::mutate(y = dplyr::if_else(satell > 0, 1, 0), # resposta
                weight = weight/1000, # transformando peso em kg
                color = color - 1) # para escala de color de 1 a 4 


tibble::as.tibble(crabs)
```

\s\s

#### **Tabelas de Frequência para as variáveis categóricas:**
```{r}
tabs <- sapply(crabs[, c("color", "spine", "satell", "y")], table)

tabs


```

\s\s

---

#### **MO: MODELO LOGÍSTICO SEM EFEITO (SOMENTE INTERCEPTO)**

**Ajuste do modelo:**

```{r}

M0 <- glm(data=crabs, y ~ 1, family=binomial(link="logit"))

summary(M0)

```


**Model Fit Statistics**:

```{r}
# AIC - no output do modelo ou via:
AIC(M0)

# -2 Log L
-2*logLik(M0)

```



---

#### **M1: MODELO LOGÍSTICO SOMENTE COM WIDTH**

**Ajuste do modelo:**

```{r}

M1 <- glm(data=crabs, y ~ width, family=binomial(link="logit"))

summary(M1)

```


**Model Fit Statistics**:

```{r}
# AIC - no output do modelo ou via:
AIC(M1)

# -2 Log L
-2*logLik(M1)

```

\s\s

**Testes de hipótese para $\beta$:**

```{r, message=FALSE}
# testes para existência de regressão

# 1) razao de verossimilhancas
library(lmtest)
lrtest(M1)

# 2) teste de Wald
waldtest(M1)
```


\s\s

**Intervalos de Confiança:**

Para *log(odds)*:

```{r}
# IC log(odds)
# summary(model)
# IC_B <- model$coefficients[2] + c(-1,1)*qnorm(0.975)*ASE

# ou
confint.default(M1)

```

\s\s

O método *.default* assume normalidade assintótica, por isso é utilizado.

Para *odds ratio*:

```{r}
# IC (odds ratio)

exp(confint.default(M1))

```


---

#### **M2.1: MODELO LOGÍSTICO COM WIDTH E COLOR (ORDINAL)**
#### **AGRESTI - INTRODUCTION TO CDA 2ND - PG.118**

**Ajuste do modelo:**

```{r}

M2.1 <- glm(data=crabs, y ~ width + color, family=binomial(link="logit"))

summary(M2.1)

```


**Model Fit Statistics**:

```{r}
# AIC - no output do modelo ou via:
AIC(M2.1)

# -2 Log L
-2*logLik(M2.1)

```

\s\s

**Testes de hipótese para $\beta$:**

```{r, message=FALSE}
# testes para existência de regressão

# 1) razao de verossimilhancas
library(lmtest)
lrtest(M2.1)

# 2) teste de Wald
waldtest(M2.1)
```


\s\s

**Intervalos de Confiança:**

Para *log(odds)*:

```{r}
# IC log(odds)
# summary(model)
# IC_B <- model$coefficients[2] + c(-1,1)*qnorm(0.975)*ASE

# ou
confint.default(M2.1)

```

\s\s

O método *.default* assume normalidade assintótica, por isso é utilizado.

Para *odds ratio*:

```{r}
# IC (odds ratio)

exp(confint.default(M2.1))

```

**Curvas Logísticas (segundo COLOR)**

Apenas para os valores preditos:

```{r, fig.width=9}

crabs %>%
  dplyr::mutate(color = factor(color, labels = c("Lt Med", "Medium", "Dk Med", "Dark"))) %>%
  #dplyr::group_by(color) %>%
  plotly::plot_ly(x=~width, y=~M2.1$fitted.values, #group=~color,
                           type="scatter", mode="markers", #color=~color, 
          split=~color) %>%
  plotly::layout(title = "Valores Preditos - COLOR(ORDINAL)")
  
```



```{r, fig.width=9}
# plot:
x_limits <- crabs %>%
  summarise(min(width)-2, max(width)+2) # obtendo os limites do eixo x


x <- seq(x_limits[[1]], x_limits[[2]], by=0.1) # criando varios ptos entre esses limites

# x <- seq(20,35, by=0.1) 

# ajustando as probabilidades (y_i's) para cada nivel de cor i
for (i in 1:4){
  assign(paste0("y",i), plogis(M2.1$coefficients[1]+M2.1$coefficients[2]*x+M2.1$coefficients[3]*i)  )
}


y_list <- list(y1,y2,y3,y4)


plotly::plot_ly(x = ~x, y = ~y1, type="scatter", mode="lines", name="Lt Med") %>%
  plotly::add_trace(y=~y2, x=~x , type="scatter", mode="lines", name="Medium") %>%
  plotly::add_trace(y=~y3, x=~x , type="scatter", mode="lines", name="Dk Med") %>%
  plotly::add_trace(y=~y4, x=~x , type="scatter", mode="lines", name="Dark") %>%
  plotly::layout(title = "Curvas Logísticas Ajustadas - COLOR(ORDINAL)")

```




---

#### **M2.2: MODELO LOGÍSTICO COM WIDTH E COLOR (NOMINAL)**
#### **AGRESTI - INTRODUCTION TO CDA 2ND - PG.116**

**Preparação dos dados:**

```{r}

# soh precisamos tratar color como fator:

crabs2 <- crabs %>%
  dplyr::mutate(color = factor(color, labels = c("Lt Med", "Medium", "Dk Med", "Dark")))

head(crabs2)

```


**Ajuste do modelo:**

```{r}


M2.2 <- glm(data=crabs2, y ~ width + color, family=binomial(link="logit"),
            contrasts=list(color=contr.treatment(4, base=4,contrasts=TRUE)))
# base na cor 4 -- dark (0,0,0)

M2.2 <- glm(data=crabs2, y ~ width + color, family=binomial(link="logit"))

summary(M2.2)

```


**Model Fit Statistics**:

```{r}
# AIC - no output do modelo ou via:
AIC(M2.2)

# -2 Log L
-2*logLik(M2.2)

```

\s\s

**Testes de hipótese para $\beta$:**

```{r, message=FALSE}
# testes para existência de regressão

# 1) razao de verossimilhancas
library(lmtest)
lrtest(M2.2)

# 2) teste de Wald
waldtest(M2.2)
```


\s\s

**Intervalos de Confiança:**

Para *log(odds)*:

```{r}
# IC log(odds)
# summary(model)
# IC_B <- model$coefficients[2] + c(-1,1)*qnorm(0.975)*ASE

# ou
confint.default(M2.2)

```

\s\s

O método *.default* assume normalidade assintótica, por isso é utilizado.

Para *odds ratio*:

```{r}
# IC (odds ratio)

exp(confint.default(M2.2))

```

**Curvas Logísticas (segundo COLOR)**

Apenas para os valores preditos:

```{r, fig.width=9}

crabs2 %>%
  # dplyr::mutate(color = factor(color, labels = c("Lt Med", "Medium", "Dk Med", "Dark"))) %>%
  #dplyr::group_by(color) %>%
  plotly::plot_ly(x=~width, y=~M2.2$fitted.values, #group=~color,
                           type="scatter", mode="markers", #color=~color, 
          split=~color) %>%
  plotly::layout(title = "Valores Preditos - COLOR(NOMINAL)")
  
```



```{r, fig.width=9}
# plot:
x_limits <- crabs2 %>%
  summarise(min(width)-2, max(width)+2) # obtendo os limites do eixo x


x <- seq(x_limits[[1]], x_limits[[2]], by=0.1) # criando varios ptos entre esses limites

# x <- seq(20,35, by=0.1)

# ajustando as probabilidades (y_i's) para cada nivel de cor i
# temos mais dois coeficientes no modelo agora, mas cuja o valor que multiplica eh 1


y1 <- plogis(M2.2$coefficients[1]+M2.2$coefficients[2]*x) # modelo com color 0 0 0 (base 4 - Dark)

for(j in 2:4){
  assign(paste0("y",i), plogis(M2.2$coefficients[1]+M2.2$coefficients[2]*x+M2.2$coefficients[i+1])  )
}



y_list <- list(y1,y2,y3,y4)


plotly::plot_ly(x = ~x, y = ~y1, type="scatter", mode="lines", name="Lt Med") %>%
  plotly::add_trace(y=~y2, x=~x , type="scatter", mode="lines", name="Medium") %>%
  plotly::add_trace(y=~y3, x=~x , type="scatter", mode="lines", name="Dk Med") %>%
  plotly::add_trace(y=~y4, x=~x , type="scatter", mode="lines", name="Dark") %>%
  plotly::layout(title = "Curvas Logísticas Ajustadas - COLOR(NOMINAL)")

```



---

#### **SELEÇÃO DE VARIÁVEIS PARA O MODELO M2.2: MODELO LOGÍSTICO COM WIDTH E COLOR (NOMINAL)**

**Preparação dos dados:**

```{r}

# soh precisamos tratar color como fator:
# ficando apenas com as variaveis de interesse y, width, color
crabs3 <- crabs2 %>%
  dplyr::select(y, width, color)


head(crabs3)

```


**Seleção Automática de Modelos:**

*Backward* a partir do modelo completo *y $\sim$ width + Lt Med + Medium + Dk Med*:

```{r}
# ajustando os dados
# precisamos fazer isso, para que a funcao step reconheça as variaveis dummy
# step(M2.2) # embora glm reconheça as dummy, a funcao step trata como uma variavel color soh com 3 g.l.

df <- as.data.frame(crabs3)
str(df)
m <- model.matrix(~color-1, data=crabs3)
df <- cbind(crabs3[,-3], m[,-4]) # tirando Dark
colnames(df) <- c("y", "width", "Lt_Med", "Medium", "Dk_Med")

tibble::as.tibble(df)


# modelo completo:
fullmod <- glm(data=df, y ~ ., family=binomial(link="logit"))

# olhar para os AIC's mais baixos

step(fullmod) # esse jah eh o melhor no backward

```

*Forward* a partir do modelo simples:

```{r}

modmin <- glm(data=df, y~1, family=binomial(link="logit"))
step(modmin, direction = "forward", scope = ~ width + Lt_Med + Medium + Dk_Med) #ok!


```


**Curva ROC para os modelo selecionados:**

```{r, fig.width=9}
library(pROC)
#https://stackoverflow.com/questions/27584099/plot-multiple-roc-curves-for-logistic-regression-model-in-r



y <- crabs2[["y"]]

# modelo 2.2 (resultante do backward)
preds1 <- predict(M2.2)
roc1=roc(y ~ preds1)

# modelo (resultante do forward)

mod_fwd <- glm(data=df, y ~ width + Medium, family=binomial(link="logit"))
preds2 <- predict(mod_fwd)
roc2=roc(y ~ preds2)

# plot(roc1)

# help(plot.roc)

# roc1 %>% 
  plotly::plot_ly(x = ~(1-roc1$specificities), y = ~roc1$sensitivities, type="scatter", mode="markers", name="ROC 1")%>%
    plotly::add_trace(x = c(0, 1), y= c(0, 1), mode = "lines", name="abline") %>%
    plotly::add_trace(x = ~(1-roc2$specificities), y = ~roc2$sensitivities, type="scatter", mode="markers", name="ROC 2") %>%
    plotly::layout(title = "Curvas ROC", xaxis=list(title="1-especificidade"), yaxis=list(title="sensibilidade"))
    

```

---

---

---

### Referências Bibliográficas

---


AGRESTI, ALAN. *An Introduction to Categorical Data Analysis*. John Wiley & Sons, second edition, 2007.

NOTAS DE AULA. *Análise de Dados Categorizados*. Curso de Graduação em Estatística, UnB, 2018.

R CORE TEAM. *R: A language and environment for statistical computing*. R Foundation for Statistical Computing, Vienna, Austria. URL https://www.R-project.org/.

---