---
title: "**Challenger** "
subtitle: "Regressão Logística - Análise de Dados Categorizados - Prova 3"
author: 
- Allan Vieira 14/0128492
- Caio Balena
- Frederico França
- José Cezário

date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    code_folding: hide
    self_contained: false
    df_print: paged
---

<!-- self_contained: false --- para nao dar pau do plotly com firefox -->
<!-- df_print para as formas de imprimir data frames e tibbles -->
<!-- ver https://rmarkdown.rstudio.com/html_document_format.html -->

<!-- incluir no cabecalho: -->
<!-- always_allow_html: yes  -->
<!--para quando formos passar para pdf -->

<style>
body {
text-align: justify}
</style>

<!-- para justificar texto no markdown -->
<!-- https://stackoverflow.com/questions/43222169/how-to-justify-the-text-to-both-sides-when-knitting-html-in-rmarkdown -->

<!-- <style> -->
<!--   .col2 { -->
<!--     columns: 2 200px;         /* number of columns and width in pixels*/ -->
<!--     -webkit-columns: 2 200px; /* chrome, safari */ -->
<!--     -moz-columns: 2 200px;    /* firefox */ -->
<!--   } -->
<!--   .col3 { -->
<!--     columns: 3 100px; -->
<!--     -webkit-columns: 3 100px; -->
<!--     -moz-columns: 3 100px; -->
<!--   } -->
<!-- </style> -->
<!-- esse de cima funciona no output do RStudio, mas nao nos browsers -->
<!-- tb em: https://stackoverflow.com/questions/31753897/2-column-section-in-r-markdown -->


<!-- para acrescentar logo da unb no cabeçalho -->
<script>
   $(document).ready(function() {
     $head = $('#header');
     $head.prepend('<img src=\"unb3.png\" style=\"float: right;width: 150px;\"/>')
   });
</script>

---

---




<!-- ```{r, echo=FALSE} -->

<!-- htmltools::img(src = knitr::image_uri(file.path(R.home("doc"), "html", "logo.jpg")),  -->
<!--                alt = 'logo',  -->
<!--                style = 'position:absolute; top:0; right:0; padding:1px;') -->

<!-- ``` -->


**Carregamento de pacotes:**

Neste exemplo são utilizados os seguintes pacotes: *dplyr*, *magrittr*, *tibble*, *plotly* e *lmtest*. Para a confecção do documento html, é necessário o pacote *rmarkdown*.

```{r, message=FALSE, warning=FALSE}
# dplyr -- para facilitar manipulacao de dados
if (!require('dplyr')) install.packages('dplyr'); library('dplyr')

# magrittr -- para facilitar manipulacao de dados
if (!require('magrittr')) install.packages('magrittr'); library('magrittr')

# tibble -- para facilitar manipulacao de dados
if (!require('tibble')) install.packages('tibble'); library('tibble')

# plotly -- para os plots
if (!require('plotly')) install.packages('plotly'); library('plotly')

# lmtest -- para os testes de razao de verossimilhancas e para o teste de wald
if (!require('lmtest')) install.packages('plotly'); library('lmtest')

```



**Carregamento dos dados:**

```{r, message=FALSE, warning=FALSE}
falhas <- c(2, 0, 0, 1, 0, 0, 1, 0, 0, 1, 2, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)

temp <- c(53, 66, 68, 70, 75, 78, 57, 67, 69, 70, 75, 79, 58, 67, 70, 72, 76, 80, 63, 67, 70, 73, 76)

challenger <- tibble::data_frame(falhas, temp)

challenger

```



\s\s

**Plot:**

```{r, fig.width=9}

challenger %>%
  #dplyr::mutate(color = factor(falhas)) %>%
  
  plotly::plot_ly(x=~temp, y=~falhas, #group=~color,
                           type="scatter", mode="markers", #color=~color, 
          split=~falhas) %>%
  plotly::layout(title = "Análises do Space Shuttle Data")


```


---

\s\s

\s\s

---

### Análises Incorretas 

---

#### Análise Incorreta 1 - Regressão Linear **SEM** zeros

**Dados:**
```{r, message=FALSE, warning=FALSE}

# removendo os zeros
challenger2 <- challenger %>%
  dplyr::filter(falhas != 0)
  
challenger2


```


**Plot:**
```{r, fig.width=9}

challenger2 %>%
  #dplyr::mutate(color = factor(falhas)) %>%
  
  plotly::plot_ly(x=~temp, y=~falhas, #group=~color,
                           type="scatter", mode="markers", #color=~color, 
          split=~falhas) %>%
  plotly::layout(title = "Análises do Space Shuttle Data\nAnálise Incorreta 1\nDados SEM zeros")


```

\s\s

**Modelo de Regressão Linear SEM zeros:**
```{r, message=FALSE, warning=FALSE}

orings = 6
challenger2 <- challenger2 %>%
  dplyr::mutate(resp = falhas/orings)

# sum of squares
aov(resp ~ temp, data = challenger2)

# regressao
fit1 <- lm(resp ~ temp, data = challenger2)
summary(fit1)

```

\s\s

**Plot:**

```{r, fig.width=9}

challenger2 %>% 
  plotly::plot_ly(x = ~temp) %>%
  plotly::add_markers(y = ~resp, name = "resp") %>% 
  plotly::add_lines(x = ~temp, y = fitted(fit1), name = "fit") %>%
  plotly::layout(title = "NASA Space Shuttle O-Ring Failures - Erro 1", yaxis=list(title="Prob. Estimada de Falha"))


```


\s\s

**Função para automatizar plots diagnósticos:**

Neste exemplo, foi confeccionada uma função parar automatizar os plots diagnósticos para regressão linear.

```{r, fig.width=9}
RegressionPlots <- function(fit, range.plt5){
  
  # Extract fitted values from lm() object
  Fitted.Values <-  fitted(fit)
  
  # Extract residuals from lm() object
  Residuals <-  resid(fit)
  
  # Extract standardized residuals from lm() object
  Standardized.Residuals <- MASS::stdres(fit)  
  
  # Extract fitted values for lm() object
  Theoretical.Quantiles <- qqnorm(Residuals, plot.it = F)$x
  
  # Square root of abs(residuals)
  Root.Residuals <- sqrt(abs(Standardized.Residuals))
  
  # Calculate Leverage
  Leverage <- lm.influence(fit)$hat
  
  #Cook's Distance
  Cooks.d <- cooks.distance(fit)
  # Cook.d <- influence.measures(fit)$infmat[,"cook.d"]
  

  # Create data frame 
  # Will be used as input to plot_ly
  
  regMat <- data.frame(Fitted.Values, 
                       Residuals, 
                       Standardized.Residuals, 
                       Theoretical.Quantiles,
                       Root.Residuals,
                       Leverage,
                       Cooks.d)
  
  
  plt1 <- regMat %>% 
    plotly::plot_ly(x = ~Fitted.Values, y = ~Residuals, 
            type = "scatter", mode = "markers", hoverinfo = "x+y", name = "Data",
            marker = list(size = 10, opacity = 0.5), showlegend = F) %>%
    #layout(title = "Residuals vs Fitted Values", plot_bgcolor = "#e6e6e6", width = 1000) 
    plotly::layout(title = "Residuals vs Fitted Values") # usar backgorund branco
    
  plt2 <- regMat %>% 
    plotly::plot_ly(x = ~Fitted.Values, y = ~Standardized.Residuals, 
            type = "scatter", mode = "markers", hoverinfo = "x+y", name = "Data",
            marker = list(size = 10, opacity = 0.5), showlegend = F) %>%
    plotly::layout(title = "Standardized Residuals vs Fitted Values")
    
  plt3 <- regMat %>% 
    plotly::plot_ly(x = ~Leverage, y = ~Standardized.Residuals, 
            type = "scatter", mode = "markers", hoverinfo = "x+y", name = "Data",
            marker = list(size = 10, opacity = 0.5), showlegend = F) %>%
    plotly::layout(title = "Residuals vs Fitted Values")
  
  plt4 <- regMat %>% 
    plotly::plot_ly(x = ~Theoretical.Quantiles) %>% 
    plotly::add_markers(y = ~Standardized.Residuals, name = "std.res", type = "scatter", mode = "markers", hoverinfo = "x+y", name = "Data",
            marker = list(size = 10, opacity = 0.5), showlegend = F) %>%
    plotly::add_lines(x = Theoretical.Quantiles, y = Theoretical.Quantiles, type="scatter", mode = "lines", name="qq") %>%
    plotly::layout(title = "Standardized Residuals vs Theoretical Quantiles") # usar backgorund branco
  
  
  # a <- list(autotick = FALSE, ticks = "outside", tick0 = 0, dtick = 0.25, ticklen = 5, tickwidth = 2, tickcolor = toRGB("blue"))
  
  #Fitted.axis <- list(autotick = FALSE, ticks = "outside", tick0 = 0, ticklen = 0.5, dtick = 0.1)
  
  plt5 <- regMat %>% 
    plotly::plot_ly(x = ~Fitted.Values) %>%
    plotly::add_markers(y = ~resp, name = "resp", data = fit$model, type = "scatter", mode = "markers", hoverinfo = "x+y", name = "Data",
            marker = list(size = 10, opacity = 0.5), showlegend = F) %>%
    #plotly::add_trace(x = c(0.15, .35), y= c(0.15, .35), mode = "lines", name="abline") %>% # ate 0.5 para a escala nao ficar ruim
    plotly::add_trace(x = range.plt5, y= range.plt5, mode = "lines", name="abline") %>% # ate 0.5 para a escala nao ficar ruim
    plotly::layout(title = "Resp vs Fitted Values") # usar backgorund branco
  #ok!
  
  obs <- seq(1, nrow(fit$model), by =1)
  plt6 <- regMat %>%
    plotly::plot_ly(showlegend = F) %>%
    plotly::add_markers( y = ~Cooks.d, x = obs, 
            type = "scatter", mode = "markers", hoverinfo = "x+y", name = "Data",
            marker = list(size = 10, opacity = 0.5), showlegend = F) %>%
    plotly::add_segments(x= obs, xend = obs, y = 0, yend = ~Cooks.d, mode="lines", color = I("gray80")) %>%
    plotly::layout(title = "Cook's distance", xaxis = list(title="Observations"))
  
  return(list(plt1, plt2, plt3, plt4, plt5, plt6))

}

```


**Plots diagnósticos:**

```{r, fig.width=9}
plt <- RegressionPlots(fit1, range.plt5 = c(0.15, 0.35))

```


<div class = "row">
<div class = "col-md-6">

```{r, fig.height=4, fig.width=4.5, warning=FALSE, message=FALSE}
plt[[1]]

plt[[3]]

plt[[5]]
```

</div>
<div class = "col-md-6">


```{r, fig.height=4, fig.width=4.5, warning=FALSE, message=FALSE}
plt[[2]]

plt[[4]]

plt[[6]]
```

</div>
</div>




---


#### Análise Incorreta 2 - Regressão Linear **COM** zeros

**Modelo de Regressão Linear COM zeros:**
```{r, message=FALSE, warning=FALSE}
# dados
orings = 6
challenger <- challenger %>%
  dplyr::mutate(resp = falhas/orings)

# removendo os zeros
# sum of squares
aov(resp ~ temp, data = challenger)

# regressao
fit2 <- lm(resp ~ temp, data = challenger)
summary(fit2)


```


**Plot:**
```{r, fig.width=9}

challenger %>% 
  plotly::plot_ly(x = ~temp) %>%
  plotly::add_markers(y = ~resp, name = "resp") %>% 
  plotly::add_lines(x = ~temp, y = fitted(fit2), name = "fit") %>%
  plotly::add_ribbons(data = broom::augment(fit2),
              ymin = ~.fitted - qnorm(0.975) * .se.fit,
              ymax = ~.fitted + qnorm(0.975) * .se.fit,
              line = list(color = 'rgba(138,43,226, 0.05)', opacity = 0.1),
              fillcolor = 'rgba(138,43,226, 0.2)', opacity = 0.25,
              name = "95% conf.") %>%
  plotly::layout(title = "NASA Space Shuttle O-Ring Failures - Erro", yaxis=list(title="Prob. Estimada de Falha"))


```


**Plots diagnósticos:**

```{r, fig.width=9}
plt2 <- RegressionPlots(fit2, range.plt5 = c(0, 0.35))

```


<div class = "row">
<div class = "col-md-6">

```{r, fig.height=4, fig.width=4.5, warning=FALSE, message=FALSE}
plt2[[1]]

plt2[[3]]


plt2[[5]]
```

</div>
<div class = "col-md-6">


```{r, fig.height=4, fig.width=4.5, warning=FALSE, message=FALSE}
plt2[[2]]

plt2[[4]]

plt2[[6]]
```

</div>
</div>


---

---

### Análise Correta

---

#### Regressão **Logística** com zeros

\s\s

\s\s

**Modelo de Regressão Logística (Binomial Regression):**
```{r, message=FALSE, warning=FALSE}
# precisamos passar os pesos - contagens para a funcao glm!!!
# eh um caso de utilizacao da funcao de veross da binomial mesmo (k sucessos em n trials)
#...e nao da bernoulli (sucesso ou fracasso para cada trial)
# ver: https://stats.stackexchange.com/questions/90622/regression-model-where-output-is-a-probability
# e https://www.r-bloggers.com/binomial-regression-model/
# como dividimos todas as falhas por 6 -- nossos pesos sao todos 6
# ai bate certinho com o SAS, inclusive SE e AIC

fit3 <- glm(resp ~ temp, data = challenger, weights = rep(6, nrow(challenger)),  family=binomial(link="logit"))

summary(fit3)

```

\s\s

**Testes e demais estatísticas do modelo:**
```{r, message=FALSE, warning=FALSE}
# logLik
-2*logLik(fit3)

# OR
exp(confint.default(fit3))

# testes para existência de regressão
# 1) razao de verossimilhancas
#library(lmtest)
lmtest::lrtest(fit3)

# 2) teste de Wald
lmtest::waldtest(fit3)


# 3) Score
anova(fit3,test="Rao")

```

\s\s

**Ajustes pré-plotagem:**

```{r}

# criando obs artificiais para suavizar a curva
x_limits <- challenger %>%
  summarise(min = 30, max = max(temp)+2) # obtendo os limites do eixo x

x <- seq(x_limits[[1]], x_limits[[2]], by=0.5) # criando varios ptos entre esses limites

# obtendo os valores de y de acordo com os parametros da reg logist
y <- plogis(fit3$coefficients[1]+fit3$coefficients[2]*x)


# fazendo a predicao das obs artificiais
# ver sol: https://stackoverflow.com/questions/26694931/how-to-plot-logit-and-probit-in-ggplot2
temp.data = data.frame(temp = x) # se nao passar a coluna com o mesmo nome da variavel nao funciona


# Predict the fitted values given the model and hypothetical data
predicted.data <- as.data.frame(predict(fit3, newdata = temp.data, 
                                        type="link", se=TRUE))

# Combine the hypothetical data and predicted values
new.data <- cbind(temp.data, predicted.data)

# Calculate confidence intervals
std <- qnorm(0.95 / 2 + 0.5)
new.data$ymin <- fit3$family$linkinv(new.data$fit - std * new.data$se)
new.data$ymax <- fit3$family$linkinv(new.data$fit + std * new.data$se)
new.data$fit <- fit3$family$linkinv(new.data$fit)  # Rescale to 0-1


```

\s\s

**Plot:**
```{r, fig.width=9}

plotly::plot_ly(x = ~x, y = ~y, name = 'fitted', type = 'scatter', mode = 'lines') %>%
  plotly::add_trace(x= ~temp, y = ~resp, name = 'res', mode = 'markers', data=challenger) %>%
  plotly::add_ribbons(data = new.data,
              ymin = ~ymin,
              ymax = ~ymax,
              line = list(color = 'rgba(138,43,226, 0.05)', opacity = 0.1),
              fillcolor = 'rgba(138,43,226, 0.2)', opacity = 0.25,
              name = "95% conf.") %>%
  plotly::layout(title = "Predicted Probabilities for falhas/orings\n With 95% Confidence Limits")


```









---

---

### Referências Bibliográficas

---


AGRESTI, ALAN. *An Introduction to Categorical Data Analysis*. John Wiley & Sons, second edition, 2007.

NOTAS DE AULA. *Análise de Dados Categorizados*. Curso de Graduação em Estatística, UnB, 2018.

R CORE TEAM. *R: A language and environment for statistical computing*. R Foundation for Statistical Computing, Vienna, Austria. URL https://www.R-project.org/.

---